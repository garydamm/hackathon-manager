# Progress Log

## Learnings
- When adding a new required field to an entity (like `createdBy`), ALL test files that construct that entity must be updated — not just the ones for the feature being changed. Search broadly with `= Project(` across all test files.
- Making an entity field nullable (e.g., `team: Team` → `team: Team?`) requires updating every access site to use `?.` or `!!.`. Use `replace_all` where appropriate.
- Hibernate `ddl-auto: validate` in repository tests (via TestContainers) means entity changes MUST align with migration changes — they can't be separated into different PRD tasks if the tests need to pass.
- Use `:test` (with project qualifier) to avoid mcp-server subproject failing when filtering tests.

---

## Iteration 1 - US-001: Database migration to decouple projects from teams
- Created V8__decouple_projects_from_teams.sql migration:
  - Makes team_id nullable, adds created_by column with FK to users
  - Backfills created_by from teams.created_by before adding NOT NULL constraint
  - Replaces partial unique index to include `WHERE team_id IS NOT NULL AND archived_at IS NULL`
  - Adds indexes on created_by and (hackathon_id, created_by)
- Updated Project entity: `team: Team` → `team: Team? = null`, added `createdBy: User` ManyToOne
- Updated ProjectDtos: `teamId: UUID` → `UUID?`, `teamName: String` → `String?`, safe-null access in fromEntity()
- Updated CreateProjectRequest: `teamId: UUID` → `UUID?`, added `hackathonId: UUID?`
- Updated ProjectService.createProject: handles nullable teamId, passes createdBy from team.createdBy
- Updated ProjectService (update/submit/unsubmit/archive): `project.team.id!!` → `project.team!!.id!!`
- Updated LeaderboardService: same `!!` pattern for team access
- Updated ALL test files constructing Project entities to include `createdBy = testUser`:
  - ProjectRepositoryTest, ProjectServiceTest, ProjectControllerTest
  - ScoringServiceTest, LeaderboardServiceTest, JudgeManagementServiceTest
  - JudgeAssignmentRepositoryTest, ScoreRepositoryTest
- Files changed:
  - src/main/resources/db/migration/V8__decouple_projects_from_teams.sql (new)
  - src/main/kotlin/com/hackathon/manager/entity/Project.kt
  - src/main/kotlin/com/hackathon/manager/dto/ProjectDtos.kt
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/service/LeaderboardService.kt
  - 7 test files updated for createdBy parameter
- Learnings for future iterations:
  - Entity changes ripple broadly — always grep for constructor usage across ALL tests
  - The `team!!.id!!` pattern is temporary — US-003 will properly handle null-team authorization
---

## Iteration 2 - US-002: Update Project entity, DTOs, and repository
- Most entity/DTO changes were already done in Iteration 1 (entity nullable team, createdBy, DTO nullable teamId/teamName, CreateProjectRequest nullable teamId + hackathonId)
- Added `createdById: UUID` and `createdByName: String` to `ProjectResponse`
- Updated `fromEntity()` to populate createdBy fields using `displayName ?: "$firstName $lastName"`
- Added 2 new repository methods:
  - `findByHackathonIdAndCreatedByIdAndArchivedAtIsNull` — query user's projects in a hackathon
  - `findByHackathonIdAndTeamIsNullAndArchivedAtIsNull` — query unlinked projects in a hackathon
- Added 4 repository tests for the new methods (user projects, unlinked projects, archived exclusion)
- Updated `ProjectControllerTest`: added `createdById`/`createdByName` to `createProjectResponse()` and `copy()`
- Files changed:
  - src/main/kotlin/com/hackathon/manager/dto/ProjectDtos.kt
  - src/main/kotlin/com/hackathon/manager/repository/ProjectRepository.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
  - src/test/kotlin/com/hackathon/manager/repository/ProjectRepositoryTest.kt
- Learnings for future iterations:
  - When adding fields to `ProjectResponse`, also update the `copy()` extension in `ProjectControllerTest`
  - The `ProjectControllerTest` is the only test that directly constructs `ProjectResponse` — service tests use `fromEntity()` via mocked entities
---

## Iteration 3 - US-003: Update ProjectService for independent project creation
- Rewrote `createProject` with two flows:
  - **With teamId**: validates team membership, hackathonId match (if provided), sets `createdBy` to requesting user (not team.createdBy)
  - **Without teamId**: requires `hackathonId`, validates hackathon exists/not archived, validates user is registered via `hackathonService.isUserRegistered()`, creates project with null team
- Added `UserRepository` dependency to `ProjectService` to look up the requesting user for `createdBy`
- Extracted `isUserAuthorized(project, userId)` private helper: checks `project.createdBy.id == userId` first, then falls back to team member check (handles null team gracefully)
- Updated `updateProject`, `submitProject`, `unsubmitProject`, `archiveProject` to use `isUserAuthorized()` — no more `project.team!!.id!!` crashes on independent projects
- Updated error messages to reflect "creator or team member" authorization
- Updated `ProjectServiceTest` comprehensively:
  - Added `@Mock UserRepository` and `userRepository.findById()` mocks for all `createProject` tests
  - Added `otherUser` fixture for tests that need a non-creator user
  - New tests: independent project creation (success, missing hackathonId, hackathon not found, archived hackathon, unregistered user), hackathonId mismatch with team, createdBy set to requesting user
  - New tests: creator can update/submit/unsubmit/archive independent projects (no team)
  - Refactored auth denial tests to use `unauthorizedUserId` (not `testUserId`, which is the creator)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
- Learnings for future iterations:
  - When testing authorization denial, use a userId that is NEITHER the creator NOR a team member — otherwise `isUserAuthorized` will pass via the creator check
  - `HackathonService.isUserRegistered()` exists and delegates to `HackathonUserRepository.existsByHackathonIdAndUserId()`
  - Adding a new repo dependency to a service only affects `@InjectMocks` tests (they auto-inject) — `@WebMvcTest` controller tests mock the service directly
---

## Iteration 4 - US-004: Add team-project link and unlink API endpoints
- Added `linkProjectToTeam(projectId, teamId, userId)` service method with validations:
  - User must be a member of the target team
  - Project and team must be in the same hackathon
  - Project must not already be linked to a team
  - Team must not already have an active (non-archived) project
  - Sets project's team to the target team
- Added `unlinkProjectFromTeam(projectId, userId)` service method with validations:
  - Project must be linked to a team
  - User must be a member of the currently linked team
  - Sets project's team to null
- Added controller endpoints:
  - `POST /api/projects/{id}/link-team/{teamId}` — links project to team
  - `POST /api/projects/{id}/unlink-team` — unlinks project from team
- Added 7 service unit tests covering all link validation cases (success, not found, not team member, different hackathons, already linked, team already has project)
- Added 4 service unit tests covering all unlink validation cases (success, not found, not linked, not team member)
- Added 8 controller tests for link/unlink endpoints (success, auth, forbidden, conflict, bad request)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/controller/ProjectController.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
- Learnings for future iterations:
  - Link/unlink are simple transactional operations — no new repository methods needed, just use `existsByTeamIdAndHackathonIdAndArchivedAtIsNull` for the team-has-project check
  - The `@InjectMocks` auto-injection means no test setup changes needed when adding new methods to existing services
---

## Iteration 5 - US-005: Update frontend types and API service layer
- Updated `Project` interface: `teamId: string` → `string | null`, `teamName: string` → `string | null`, added `createdById: string` and `createdByName: string`
- Updated `CreateProjectRequest` interface: `teamId: string` → `string?` (optional), added required `hackathonId: string`
- Added 3 new methods to `projectService`:
  - `linkProjectToTeam(projectId, teamId)` — POST `/projects/{id}/link-team/{teamId}`
  - `unlinkProjectFromTeam(projectId)` — POST `/projects/{id}/unlink-team`
  - `getUnlinkedProjects(hackathonId)` — GET `/projects/hackathon/{hackathonId}/unlinked`
- Added backend support for `getUnlinkedProjects`:
  - `ProjectService.getUnlinkedProjectsByHackathon()` using existing `findByHackathonIdAndTeamIsNullAndArchivedAtIsNull` repository method
  - `ProjectController` GET endpoint `/api/projects/hackathon/{hackathonId}/unlinked`
  - Controller test for the new endpoint
- Updated `TeamDetailPage.tsx` createProject call to include `hackathonId: hackathon!.id` (now required)
- Updated `TeamDetailPage.test.tsx` mock Project to include `createdById` and `createdByName`
- Updated `ProjectControllerTest` `createProjectResponse` helper to accept nullable `teamId`/`teamName` parameters
- Files changed:
  - frontend/src/types/index.ts
  - frontend/src/services/projects.ts
  - frontend/src/pages/TeamDetailPage.tsx
  - frontend/src/pages/TeamDetailPage.test.tsx
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/controller/ProjectController.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
- Learnings for future iterations:
  - Adding required fields to `Project` interface requires updating ALL test files that construct Project objects (same pattern as backend)
  - When adding `hackathonId` as required to `CreateProjectRequest`, all existing `createProject` call sites must be updated
  - Jackson includes null values in JSON by default (`"teamId": null`), so `jsonPath("$[0].teamId").isEmpty` won't work — use `.value(null)` or assert a non-null field instead
  - Frontend `npm run typecheck` doesn't exist — use `npx tsc -b --noEmit` or the `build` script
---

## Iteration 6 - US-006: Update project creation UI for independent projects
- Added "Create Project" button to the `ProjectsSection` in `HackathonDetail.tsx`
  - Button visible only to registered participants (`hackathon.userRole === "participant"`)
  - Also shows as a CTA in the empty state when no projects exist
- Reused existing `ProjectForm` modal component (same one used by TeamDetailPage)
- Form submits with `hackathonId` only (no `teamId`), creating an independent project
- Added `createProjectMutation` with React Query cache invalidation on `["projects", "hackathon", hackathon.id]`
- TeamDetailPage project creation still works unchanged (sends both `hackathonId` and `teamId`)
- Files changed:
  - frontend/src/pages/HackathonDetail.tsx (added ProjectForm import, CreateProjectRequest type, mutation, button, form modal)
  - PRD.md (marked US-006 criteria complete)
- Learnings for future iterations:
  - `ProjectForm` component is fully reusable — just pass `onSubmit` handler that builds the right `CreateProjectRequest` (with or without teamId)
  - The `ProjectsSection` was previously a simple display component; it now has mutation state. `useQueryClient` was already imported at the file level.
  - "Verify changes work in browser" is left unchecked as it requires manual testing
---

## Iteration 7 - US-007: Add team-project linking and unlinking UI
- Added "Link Existing Project" button on TeamDetailPage when team has no linked project (alongside existing "Create Project" button)
- "Link Existing Project" opens a modal that fetches and lists unlinked projects in the hackathon via `getUnlinkedProjects` API
- User can select a project from the list and confirm to link it via `linkProjectToTeam` API
- Added "Unlink Project" button in the project header actions when team has a linked project
- "Unlink Project" shows a confirmation dialog, then calls `unlinkProjectFromTeam` API
- React Query cache invalidation covers: `["project", "team", teamId]`, `["projects", "hackathon", hackathonId]`, `["projects", "unlinked", hackathonId]`, `["team", teamId]`
- Updated empty-state text from "Your team hasn't created a project yet." to "Your team doesn't have a linked project yet."
- Updated test to match new empty-state text
- Files changed:
  - frontend/src/pages/TeamDetailPage.tsx (link/unlink mutations, modals, buttons)
  - frontend/src/pages/TeamDetailPage.test.tsx (updated empty-state text assertion)
  - PRD.md (marked US-007 criteria complete)
- Learnings for future iterations:
  - Changing user-facing strings in components requires updating corresponding test assertions
  - The unlinked projects query uses `enabled: showLinkProjectModal` to only fetch when the modal is open (lazy loading)
  - Link/unlink errors display inline in the modal/dialog using the same error pattern as join/leave team
---

## Iteration 8 - US-008: Update project display components for optional team
- Updated `ProjectCard` to show "By [createdByName]" with User icon when `teamName` is null, vs team name with Users icon when linked
- Updated `ProjectDetailModal`:
  - Added `hackathonSlug` optional prop to enable team detail links
  - When team linked: shows team name as clickable link to team detail page
  - When no team: shows "By [createdByName]" with User icon instead
- Updated `ProjectsSection` in `HackathonDetail.tsx`:
  - Added filter tabs: "All" / "Team Projects" / "Independent"
  - Filter uses `project.teamId` null check to categorize
  - Empty state message adapts to show "No team projects found" or "No independent projects found"
- Passed `hackathonSlug={hackathon.slug}` to `ProjectDetailModal` from `ProjectsSection`
- Files changed:
  - frontend/src/components/ProjectCard.tsx (conditional team/creator display)
  - frontend/src/components/ProjectDetailModal.tsx (hackathonSlug prop, team link, creator fallback)
  - frontend/src/pages/HackathonDetail.tsx (filter state, filteredProjects, filter tabs UI)
  - PRD.md (marked US-008 criteria complete)
- Learnings for future iterations:
  - Adding props to shared components like `ProjectDetailModal` requires updating all call sites (only one in this case: ProjectsSection)
  - The filter tab pattern (bg-muted container with selectable bg-background items) matches shadcn's pill/tab style
  - "Verify changes work in browser" is left unchecked as it requires manual testing
---

## Iteration 9 - US-009: UI system tests for decoupled project-team workflow
- Created `frontend/e2e/project-team-decouple.spec.ts` with 4 serial Playwright e2e tests:
  1. **Create project independently**: Navigates to hackathon page, clicks "Create Project", fills form (no teamId), verifies project appears in list with "By [createdByName]" display, confirms teamId is null via API
  2. **Create project from team context**: Navigates to team detail page, creates project from there, verifies it appears on team page, confirms teamId matches via API
  3. **Unlink project from team**: Navigates to team detail page with linked project, clicks "Unlink Project", confirms dialog, verifies team shows empty state, confirms project still exists via API with null teamId
  4. **Link project to team**: Navigates to team detail page (no project), clicks "Link Existing Project", selects unlinked project from modal, confirms, verifies project appears on team page, confirms teamId matches via API
- Test setup: Registers test user, creates hackathon, creates team via API (same pattern as other e2e tests)
- Tests run serially since they share state (project created in test 1 is linked in test 4)
- TypeScript typecheck passes
- Frontend unit tests (216 tests) all pass — no regressions
- E2e tests require running backend + frontend servers to execute
- Files changed:
  - frontend/e2e/project-team-decouple.spec.ts (new)
  - PRD.md (marked US-009 criteria complete)
- Learnings for future iterations:
  - E2e tests can't run without servers — "UI system tests pass" left unchecked as it needs `./gradlew bootRun` + `npm run dev`
  - Playwright's `reuseExistingServer: !process.env.CI` means it expects dev server already running locally (non-CI)
  - Serial test ordering matters — unlink test runs before link test so there's an unlinked project to pick from the modal
  - Verifying API responses in e2e tests (`page.request.get`) is the reliable way to assert teamId/null
---
