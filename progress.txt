# Progress Log

## Learnings
- When adding a new required field to an entity (like `createdBy`), ALL test files that construct that entity must be updated — not just the ones for the feature being changed. Search broadly with `= Project(` across all test files.
- Making an entity field nullable (e.g., `team: Team` → `team: Team?`) requires updating every access site to use `?.` or `!!.`. Use `replace_all` where appropriate.
- Hibernate `ddl-auto: validate` in repository tests (via TestContainers) means entity changes MUST align with migration changes — they can't be separated into different PRD tasks if the tests need to pass.
- Use `:test` (with project qualifier) to avoid mcp-server subproject failing when filtering tests.

---

## Iteration 1 - US-001: Database migration to decouple projects from teams
- Created V8__decouple_projects_from_teams.sql migration:
  - Makes team_id nullable, adds created_by column with FK to users
  - Backfills created_by from teams.created_by before adding NOT NULL constraint
  - Replaces partial unique index to include `WHERE team_id IS NOT NULL AND archived_at IS NULL`
  - Adds indexes on created_by and (hackathon_id, created_by)
- Updated Project entity: `team: Team` → `team: Team? = null`, added `createdBy: User` ManyToOne
- Updated ProjectDtos: `teamId: UUID` → `UUID?`, `teamName: String` → `String?`, safe-null access in fromEntity()
- Updated CreateProjectRequest: `teamId: UUID` → `UUID?`, added `hackathonId: UUID?`
- Updated ProjectService.createProject: handles nullable teamId, passes createdBy from team.createdBy
- Updated ProjectService (update/submit/unsubmit/archive): `project.team.id!!` → `project.team!!.id!!`
- Updated LeaderboardService: same `!!` pattern for team access
- Updated ALL test files constructing Project entities to include `createdBy = testUser`:
  - ProjectRepositoryTest, ProjectServiceTest, ProjectControllerTest
  - ScoringServiceTest, LeaderboardServiceTest, JudgeManagementServiceTest
  - JudgeAssignmentRepositoryTest, ScoreRepositoryTest
- Files changed:
  - src/main/resources/db/migration/V8__decouple_projects_from_teams.sql (new)
  - src/main/kotlin/com/hackathon/manager/entity/Project.kt
  - src/main/kotlin/com/hackathon/manager/dto/ProjectDtos.kt
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/service/LeaderboardService.kt
  - 7 test files updated for createdBy parameter
- Learnings for future iterations:
  - Entity changes ripple broadly — always grep for constructor usage across ALL tests
  - The `team!!.id!!` pattern is temporary — US-003 will properly handle null-team authorization
---

## Iteration 2 - US-002: Update Project entity, DTOs, and repository
- Most entity/DTO changes were already done in Iteration 1 (entity nullable team, createdBy, DTO nullable teamId/teamName, CreateProjectRequest nullable teamId + hackathonId)
- Added `createdById: UUID` and `createdByName: String` to `ProjectResponse`
- Updated `fromEntity()` to populate createdBy fields using `displayName ?: "$firstName $lastName"`
- Added 2 new repository methods:
  - `findByHackathonIdAndCreatedByIdAndArchivedAtIsNull` — query user's projects in a hackathon
  - `findByHackathonIdAndTeamIsNullAndArchivedAtIsNull` — query unlinked projects in a hackathon
- Added 4 repository tests for the new methods (user projects, unlinked projects, archived exclusion)
- Updated `ProjectControllerTest`: added `createdById`/`createdByName` to `createProjectResponse()` and `copy()`
- Files changed:
  - src/main/kotlin/com/hackathon/manager/dto/ProjectDtos.kt
  - src/main/kotlin/com/hackathon/manager/repository/ProjectRepository.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
  - src/test/kotlin/com/hackathon/manager/repository/ProjectRepositoryTest.kt
- Learnings for future iterations:
  - When adding fields to `ProjectResponse`, also update the `copy()` extension in `ProjectControllerTest`
  - The `ProjectControllerTest` is the only test that directly constructs `ProjectResponse` — service tests use `fromEntity()` via mocked entities
---

## Iteration 3 - US-003: Update ProjectService for independent project creation
- Rewrote `createProject` with two flows:
  - **With teamId**: validates team membership, hackathonId match (if provided), sets `createdBy` to requesting user (not team.createdBy)
  - **Without teamId**: requires `hackathonId`, validates hackathon exists/not archived, validates user is registered via `hackathonService.isUserRegistered()`, creates project with null team
- Added `UserRepository` dependency to `ProjectService` to look up the requesting user for `createdBy`
- Extracted `isUserAuthorized(project, userId)` private helper: checks `project.createdBy.id == userId` first, then falls back to team member check (handles null team gracefully)
- Updated `updateProject`, `submitProject`, `unsubmitProject`, `archiveProject` to use `isUserAuthorized()` — no more `project.team!!.id!!` crashes on independent projects
- Updated error messages to reflect "creator or team member" authorization
- Updated `ProjectServiceTest` comprehensively:
  - Added `@Mock UserRepository` and `userRepository.findById()` mocks for all `createProject` tests
  - Added `otherUser` fixture for tests that need a non-creator user
  - New tests: independent project creation (success, missing hackathonId, hackathon not found, archived hackathon, unregistered user), hackathonId mismatch with team, createdBy set to requesting user
  - New tests: creator can update/submit/unsubmit/archive independent projects (no team)
  - Refactored auth denial tests to use `unauthorizedUserId` (not `testUserId`, which is the creator)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
- Learnings for future iterations:
  - When testing authorization denial, use a userId that is NEITHER the creator NOR a team member — otherwise `isUserAuthorized` will pass via the creator check
  - `HackathonService.isUserRegistered()` exists and delegates to `HackathonUserRepository.existsByHackathonIdAndUserId()`
  - Adding a new repo dependency to a service only affects `@InjectMocks` tests (they auto-inject) — `@WebMvcTest` controller tests mock the service directly
---

## Iteration 4 - US-004: Add team-project link and unlink API endpoints
- Added `linkProjectToTeam(projectId, teamId, userId)` service method with validations:
  - User must be a member of the target team
  - Project and team must be in the same hackathon
  - Project must not already be linked to a team
  - Team must not already have an active (non-archived) project
  - Sets project's team to the target team
- Added `unlinkProjectFromTeam(projectId, userId)` service method with validations:
  - Project must be linked to a team
  - User must be a member of the currently linked team
  - Sets project's team to null
- Added controller endpoints:
  - `POST /api/projects/{id}/link-team/{teamId}` — links project to team
  - `POST /api/projects/{id}/unlink-team` — unlinks project from team
- Added 7 service unit tests covering all link validation cases (success, not found, not team member, different hackathons, already linked, team already has project)
- Added 4 service unit tests covering all unlink validation cases (success, not found, not linked, not team member)
- Added 8 controller tests for link/unlink endpoints (success, auth, forbidden, conflict, bad request)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/controller/ProjectController.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
- Learnings for future iterations:
  - Link/unlink are simple transactional operations — no new repository methods needed, just use `existsByTeamIdAndHackathonIdAndArchivedAtIsNull` for the team-has-project check
  - The `@InjectMocks` auto-injection means no test setup changes needed when adding new methods to existing services
---

## Iteration 5 - US-005: Update frontend types and API service layer
- Updated `Project` interface: `teamId: string` → `string | null`, `teamName: string` → `string | null`, added `createdById: string` and `createdByName: string`
- Updated `CreateProjectRequest` interface: `teamId: string` → `string?` (optional), added required `hackathonId: string`
- Added 3 new methods to `projectService`:
  - `linkProjectToTeam(projectId, teamId)` — POST `/projects/{id}/link-team/{teamId}`
  - `unlinkProjectFromTeam(projectId)` — POST `/projects/{id}/unlink-team`
  - `getUnlinkedProjects(hackathonId)` — GET `/projects/hackathon/{hackathonId}/unlinked`
- Added backend support for `getUnlinkedProjects`:
  - `ProjectService.getUnlinkedProjectsByHackathon()` using existing `findByHackathonIdAndTeamIsNullAndArchivedAtIsNull` repository method
  - `ProjectController` GET endpoint `/api/projects/hackathon/{hackathonId}/unlinked`
  - Controller test for the new endpoint
- Updated `TeamDetailPage.tsx` createProject call to include `hackathonId: hackathon!.id` (now required)
- Updated `TeamDetailPage.test.tsx` mock Project to include `createdById` and `createdByName`
- Updated `ProjectControllerTest` `createProjectResponse` helper to accept nullable `teamId`/`teamName` parameters
- Files changed:
  - frontend/src/types/index.ts
  - frontend/src/services/projects.ts
  - frontend/src/pages/TeamDetailPage.tsx
  - frontend/src/pages/TeamDetailPage.test.tsx
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/controller/ProjectController.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
- Learnings for future iterations:
  - Adding required fields to `Project` interface requires updating ALL test files that construct Project objects (same pattern as backend)
  - When adding `hackathonId` as required to `CreateProjectRequest`, all existing `createProject` call sites must be updated
  - Jackson includes null values in JSON by default (`"teamId": null`), so `jsonPath("$[0].teamId").isEmpty` won't work — use `.value(null)` or assert a non-null field instead
  - Frontend `npm run typecheck` doesn't exist — use `npx tsc -b --noEmit` or the `build` script
---
