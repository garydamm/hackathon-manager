# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 16 - Create EventAttendeeRepository
- Created EventAttendeeRepository.kt extending JpaRepository
- Added methods: findByEventIdAndUserId, findByEventIdOrderByUserLastNameAscUserFirstNameAsc, existsByEventIdAndUserId, countByEventIdAndRsvpStatus, deleteByEventIdAndUserId
- Files changed:
  - src/main/kotlin/com/hackathon/manager/repository/EventAttendeeRepository.kt (created)
- Learnings for future iterations:
  - Repository pattern follows standard Spring Data JPA conventions
  - Method names follow query derivation pattern: findBy/existsBy/countBy/deleteBy + property combinations
  - EventAttendee entity already existed with proper relationships to ScheduleEvent and User
  - Repositories are simple interfaces - Spring generates implementation automatically
---

## Iteration 17 - Add EventAttendee DTOs
- Created EventAttendeeDtos.kt with all required DTOs
- Added EventAttendeeResponse with fromEntity() companion method that extracts user details from the EventAttendee entity
- Added RsvpRequest with @Pattern validation for rsvpStatus (attending|maybe|not_attending)
- Added MarkAttendanceRequest for single user attendance tracking
- Added BulkMarkAttendanceRequest for marking multiple users at once
- Files changed:
  - src/main/kotlin/com/hackathon/manager/dto/EventAttendeeDtos.kt (created)
  - PRD.md (marked US-002 complete)
- Learnings for future iterations:
  - DTO pattern follows existing codebase conventions with data classes and validation annotations
  - Response DTOs use companion object with fromEntity() factory method
  - Request DTOs use Jakarta validation annotations (@NotBlank, @NotNull, @Pattern)
  - @Pattern annotation validates enum-like string values for rsvpStatus
  - EventAttendeeResponse includes user details (firstName, lastName, email) by accessing attendee.user properties
---

## Iteration 18 - Update ScheduleEventResponse with RSVP data
- Updated ScheduleEventResponse data class to include RSVP and attendance fields
- Added 5 new fields: attendingCount, maybeCount, notAttendingCount, userRsvpStatus, userAttended
- Updated fromEntity() companion method signature to accept RSVP counts and optional EventAttendee
- Added EventAttendee import to ScheduleEventDtos.kt
- Files changed:
  - src/main/kotlin/com/hackathon/manager/dto/ScheduleEventDtos.kt
  - PRD.md (marked US-003 complete)
- Learnings for future iterations:
  - Response DTOs can be enhanced with additional optional parameters in fromEntity() to support different contexts
  - Default parameter values (= 0, = null) allow backwards compatibility when updating DTOs
  - RSVP counts are passed separately from the entity since they require aggregation queries
  - userAttendee parameter is nullable to support both authenticated and unauthenticated requests
---

## Iteration 19 - Add isUserRegistered helper to HackathonService
- Added isUserRegistered(hackathonId, userId) method to HackathonService
- Method uses hackathonUserRepository.existsByHackathonIdAndUserId() to return boolean
- Added @Transactional(readOnly = true) annotation following service layer pattern
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/HackathonService.kt
  - PRD.md (marked US-004 complete)
- Learnings for future iterations:
  - HackathonUserRepository already has existsByHackathonIdAndUserId() method
  - Helper methods in service layer should follow @Transactional(readOnly = true) pattern for read operations
  - isUserRegistered checks if user has ANY role in the hackathon (organizer, judge, admin, or participant)
  - This is useful for RSVP validation - any registered user can RSVP to events
---

## Iteration 20 - Add RSVP service methods to ScheduleService
- Injected eventAttendeeRepository, userRepository, and hackathonService into ScheduleService constructor
- Added getScheduleByHackathonWithRsvp(hackathonId, userId?) method that includes RSVP counts per event
- Added rsvpToEvent(eventId, userId, rsvpStatus) method that creates or updates RSVP with full validation
- Added removeRsvp(eventId, userId) method that deletes RSVP records
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ScheduleService.kt
  - PRD.md (marked US-005 complete)
- Learnings for future iterations:
  - countByEventIdAndRsvpStatus returns Long, must convert to Int using .toInt() for ScheduleEventResponse
  - getScheduleByHackathonWithRsvp queries RSVP counts for each event and includes user's RSVP status if userId provided
  - rsvpToEvent validates: rsvpStatus enum, event exists, user exists, and user is registered for hackathon
  - When creating/updating RSVP, use findByEventIdAndUserId() first, create new EventAttendee if null
  - removeRsvp uses deleteByEventIdAndUserId() which is safe even if record doesn't exist
  - Service layer handles all business logic and validation before repository operations
---

## Iteration 21 - Add attendance tracking service methods
- Added three methods to ScheduleService for organizer-only attendance tracking
- Added getEventAttendees(eventId, requesterId) that returns sorted list of attendees with RSVP/attendance data
- Added markAttendance(eventId, userId, attended, requesterId) for marking single user attendance
- Added bulkMarkAttendance(eventId, userIds, attended, requesterId) for marking multiple users at once
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ScheduleService.kt
  - PRD.md (marked US-006 complete)
- Learnings for future iterations:
  - Authorization pattern: validate entity exists first, then check isUserOrganizer() before any operations
  - All attendance methods throw ApiException with FORBIDDEN status if requester is not organizer
  - markAttendance and bulkMarkAttendance create EventAttendee records if they don't exist (similar to RSVP pattern)
  - getEventAttendees uses findByEventIdOrderByUserLastNameAscUserFirstNameAsc for alphabetical sorting
  - bulkMarkAttendance validates each userId exists before updating to provide specific error messages
  - EventAttendeeResponse.fromEntity() imported to return properly formatted attendee lists
---

## Iteration 22 - Add RSVP endpoints to ScheduleController
- Updated existing GET /schedule/hackathon/{hackathonId} to use getScheduleByHackathonWithRsvp()
- Added POST /schedule/{eventId}/rsvp endpoint that creates new RSVP and returns 201 CREATED
- Added PUT /schedule/{eventId}/rsvp endpoint that updates existing RSVP and returns 200 OK
- Added DELETE /schedule/{eventId}/rsvp endpoint that removes RSVP and returns 204 NO CONTENT
- Files changed:
  - src/main/kotlin/com/hackathon/manager/controller/ScheduleController.kt
  - PRD.md (marked US-007 complete)
- Learnings for future iterations:
  - GET endpoint accepts nullable @AuthenticationPrincipal to support both authenticated and unauthenticated requests
  - POST and PUT endpoints both call rsvpToEvent() service method (creates or updates)
  - All RSVP endpoints require authentication since they use @AuthenticationPrincipal principal (non-nullable)
  - RsvpRequest DTO includes validation, so @Valid annotation ensures proper validation
  - Service layer returns ScheduleEventResponse with updated RSVP counts for immediate UI feedback
  - DELETE endpoint uses noContent() for 204 status with no body
---
