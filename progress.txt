# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 52 - Add EmailServiceImpl unit tests
- Implemented comprehensive EmailServiceImplTest.kt with 9 test cases
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/service/EmailServiceImplTest.kt
  - Updated: PRD.md (marked US-001 as complete)
- Learnings for future iterations:
  - When mocking Resend CreateEmailResponse, use mock<CreateEmailResponse> { on { id } doReturn "value" } instead of builder pattern
  - Use lenient().whenever() in @BeforeEach when some tests don't use all mocked dependencies to avoid UnnecessaryStubbingException
  - ReflectionTestUtils.setField() is useful for injecting mocks into Spring-managed beans in tests
  - Email service tests should verify both HTML and text content for all email types
  - Console fallback mode should be tested separately from API mode
  - Coverage achieved: 100% for EmailServiceImpl (exceeds 80% requirement)
---

## Iteration 53 - Add UserService password reset workflow tests
- Added 13 comprehensive tests for password reset functionality to UserServiceTest.kt
- Files changed:
  - Updated: src/test/kotlin/com/hackathon/manager/service/UserServiceTest.kt (added password reset tests)
  - Updated: PRD.md (marked US-002 as complete)
- Learnings for future iterations:
  - When testing time-based expiry, use OffsetDateTime assertions with buffers (e.g., isAfter/isBefore with +/-1 minute) to handle test execution time
  - Use argThat {} matchers for complex object assertions in Mockito verify() calls
  - Test security features like "silent success for non-existent email" explicitly to document intent
  - When testing token invalidation, create multiple token instances and verify usedAt field changes
  - Password validation tests should cover all validation rules: length, uppercase, lowercase, numbers
  - Mock PasswordEncoder.encode() to return predictable values for assertion
  - All password reset workflow tests passed (22 total tests in UserServiceTest)
  - Coverage achieved: 100% for all password reset methods (requestPasswordReset, validateResetToken, resetPassword, validatePassword)
---

## Iteration 54 - Add ScheduledTasks unit tests
- Created comprehensive ScheduledTasksTest.kt with 6 test cases
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/scheduler/ScheduledTasksTest.kt
  - Updated: PRD.md (marked US-003 as complete)
- Learnings for future iterations:
  - Avoid ArgumentCaptor in favor of argThat {} matchers for better Kotlin/Mockito integration
  - Initial attempt with ArgumentCaptor caused NullPointerException and InvalidUseOfMatchersException
  - Use argThat {} with lambda predicates for validating method arguments (same pattern as UserServiceTest)
  - When testing scheduled tasks, verify time calculations with tolerance buffers (e.g., +/-1 minute)
  - Test edge cases: no expired tokens (returns 0), single token, batch deletion of 100 tokens
  - Verify repository method is called exactly once with correct cutoff time
  - The ScheduledTasks class deletes tokens expired more than 7 days ago (not just expired tokens)
  - All 6 tests passed successfully
  - Coverage achieved: 100% for ScheduledTasks (exceeds 80% requirement)
---

## Iteration 55 - Extract magic numbers to constants file
- Created AppConstants.kt with SecurityConstants object containing all security-related magic numbers
- Files changed:
  - Created: src/main/kotlin/com/hackathon/manager/config/AppConstants.kt
  - Updated: src/main/kotlin/com/hackathon/manager/service/UserService.kt (replaced magic numbers with constants)
  - Updated: src/main/kotlin/com/hackathon/manager/security/JwtTokenProvider.kt (replaced magic number with constant)
  - Updated: src/test/kotlin/com/hackathon/manager/service/UserServiceTest.kt (updated to use constants in assertions)
  - Updated: PRD.md (marked US-004 as complete)
- Learnings for future iterations:
  - Centralizing constants in a single file makes configuration values easier to maintain and understand
  - Use object declarations for constant grouping (SecurityConstants within AppConstants) for better organization
  - When updating error messages that include magic numbers, use string interpolation: "at least ${MIN_PASSWORD_LENGTH} characters"
  - Test assertions that check for time windows should also use the constants for consistency
  - Some tests (HackathonServiceTest, ScheduleServiceTest) were already failing before this change due to missing mock dependencies - not related to constants extraction
  - All relevant tests (UserServiceTest, EmailServiceImplTest, ScheduledTasksTest) pass with constants
  - Typecheck passes and application builds successfully (bootJar completed)
---
