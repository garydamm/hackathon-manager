# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 52 - Add EmailServiceImpl unit tests
- Implemented comprehensive EmailServiceImplTest.kt with 9 test cases
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/service/EmailServiceImplTest.kt
  - Updated: PRD.md (marked US-001 as complete)
- Learnings for future iterations:
  - When mocking Resend CreateEmailResponse, use mock<CreateEmailResponse> { on { id } doReturn "value" } instead of builder pattern
  - Use lenient().whenever() in @BeforeEach when some tests don't use all mocked dependencies to avoid UnnecessaryStubbingException
  - ReflectionTestUtils.setField() is useful for injecting mocks into Spring-managed beans in tests
  - Email service tests should verify both HTML and text content for all email types
  - Console fallback mode should be tested separately from API mode
  - Coverage achieved: 100% for EmailServiceImpl (exceeds 80% requirement)
---

## Iteration 53 - Add UserService password reset workflow tests
- Added 13 comprehensive tests for password reset functionality to UserServiceTest.kt
- Files changed:
  - Updated: src/test/kotlin/com/hackathon/manager/service/UserServiceTest.kt (added password reset tests)
  - Updated: PRD.md (marked US-002 as complete)
- Learnings for future iterations:
  - When testing time-based expiry, use OffsetDateTime assertions with buffers (e.g., isAfter/isBefore with +/-1 minute) to handle test execution time
  - Use argThat {} matchers for complex object assertions in Mockito verify() calls
  - Test security features like "silent success for non-existent email" explicitly to document intent
  - When testing token invalidation, create multiple token instances and verify usedAt field changes
  - Password validation tests should cover all validation rules: length, uppercase, lowercase, numbers
  - Mock PasswordEncoder.encode() to return predictable values for assertion
  - All password reset workflow tests passed (22 total tests in UserServiceTest)
  - Coverage achieved: 100% for all password reset methods (requestPasswordReset, validateResetToken, resetPassword, validatePassword)
---

## Iteration 54 - Add ScheduledTasks unit tests
- Created comprehensive ScheduledTasksTest.kt with 6 test cases
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/scheduler/ScheduledTasksTest.kt
  - Updated: PRD.md (marked US-003 as complete)
- Learnings for future iterations:
  - Avoid ArgumentCaptor in favor of argThat {} matchers for better Kotlin/Mockito integration
  - Initial attempt with ArgumentCaptor caused NullPointerException and InvalidUseOfMatchersException
  - Use argThat {} with lambda predicates for validating method arguments (same pattern as UserServiceTest)
  - When testing scheduled tasks, verify time calculations with tolerance buffers (e.g., +/-1 minute)
  - Test edge cases: no expired tokens (returns 0), single token, batch deletion of 100 tokens
  - Verify repository method is called exactly once with correct cutoff time
  - The ScheduledTasks class deletes tokens expired more than 7 days ago (not just expired tokens)
  - All 6 tests passed successfully
  - Coverage achieved: 100% for ScheduledTasks (exceeds 80% requirement)
---

## Iteration 55 - Extract magic numbers to constants file
- Created AppConstants.kt with SecurityConstants object containing all security-related magic numbers
- Files changed:
  - Created: src/main/kotlin/com/hackathon/manager/config/AppConstants.kt
  - Updated: src/main/kotlin/com/hackathon/manager/service/UserService.kt (replaced magic numbers with constants)
  - Updated: src/main/kotlin/com/hackathon/manager/security/JwtTokenProvider.kt (replaced magic number with constant)
  - Updated: src/test/kotlin/com/hackathon/manager/service/UserServiceTest.kt (updated to use constants in assertions)
  - Updated: PRD.md (marked US-004 as complete)
- Learnings for future iterations:
  - Centralizing constants in a single file makes configuration values easier to maintain and understand
  - Use object declarations for constant grouping (SecurityConstants within AppConstants) for better organization
  - When updating error messages that include magic numbers, use string interpolation: "at least ${MIN_PASSWORD_LENGTH} characters"
  - Test assertions that check for time windows should also use the constants for consistency
  - Some tests (HackathonServiceTest, ScheduleServiceTest) were already failing before this change due to missing mock dependencies - not related to constants extraction
  - All relevant tests (UserServiceTest, EmailServiceImplTest, ScheduledTasksTest) pass with constants
  - Typecheck passes and application builds successfully (bootJar completed)
---

## Iteration 56 - Add AnnouncementController tests
- Created comprehensive AnnouncementControllerTest.kt with 11 test cases covering all CRUD operations and authorization
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/controller/AnnouncementControllerTest.kt
  - Updated: PRD.md (marked US-005 as complete)
- Learnings for future iterations:
  - Controller tests use @WebMvcTest annotation with excludeFilters to exclude JwtAuthenticationFilter
  - Use .with(user(createUserPrincipal())) to provide authenticated user context for MockMvc requests
  - Use .with(csrf()) for POST/PUT/DELETE requests to satisfy CSRF protection
  - Test helper methods (createUserPrincipal, createAnnouncementResponse) reduce duplication and improve readability
  - Test both success and failure paths: successful operations + 403 Forbidden for non-organizers + 404 Not Found for missing resources
  - MockBean for both the service under test (AnnouncementService) and dependencies (HackathonService, JwtTokenProvider)
  - All 11 tests passed on first run
  - Typecheck passed successfully
  - Controller tests validate HTTP layer behavior (status codes, JSON response structure) without testing business logic
---

## Iteration 57 - Add ScheduleController tests
- Created comprehensive ScheduleControllerTest.kt with 11 test cases covering schedule management, RSVP, and attendance tracking
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/controller/ScheduleControllerTest.kt
  - Updated: PRD.md (marked US-006 as complete)
- Learnings for future iterations:
  - Follow the same pattern as AnnouncementControllerTest: @WebMvcTest with excludeFilters for JwtAuthenticationFilter
  - Create helper methods (createUserPrincipal, createScheduleEventResponse, createEventAttendeeResponse) for test data
  - ScheduleController has two major sections: event management (CRUD) and RSVP/attendance tracking
  - Event management endpoints (POST/PUT/DELETE) require organizer role verification via hackathonService.isUserOrganizer()
  - RSVP endpoints (POST/PUT/DELETE /rsvp) allow any authenticated user to manage their own RSVPs
  - Attendance endpoints (POST /attendance, POST /attendance/bulk) are for organizers to mark who attended events
  - Use verify() to ensure service methods are called with correct parameters for operations without response bodies
  - All 11 tests passed on first run
  - Typecheck passed successfully
  - Pattern is well-established: controller tests are straightforward when following the existing template
---

## Iteration 58 - Add JudgingController tests
- Created comprehensive JudgingControllerTest.kt with 20 test cases covering all judging endpoints
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/controller/JudgingControllerTest.kt
  - Updated: PRD.md (marked US-007 as complete)
- Learnings for future iterations:
  - JudgingController has four main sections: criteria management, judge management, scoring/assignments, and leaderboard
  - Criteria CRUD operations (POST/PUT/DELETE) require organizer role and throw 403 for non-organizers
  - Judge management (add/remove judges) is organizer-only functionality
  - Assignment endpoints are for judges to view their assigned projects and submit scores
  - Leaderboard endpoint calculates rankings based on weighted scores across criteria
  - Helper methods for test data (createJudgingCriteriaResponse, createJudgeInfoResponse, createJudgeAssignmentResponse, createLeaderboardEntryResponse) improve readability
  - Use BigDecimal for weight values in judging criteria (e.g., BigDecimal("1.5"))
  - ScoreResponse includes criteriaAverages in LeaderboardEntryResponse for detailed breakdown
  - All 20 tests passed on first run
  - Typecheck passed successfully
  - Following established pattern made test creation straightforward and reliable
---

## Iteration 59 - Add HealthController tests
- Created HealthControllerTest.kt with 3 test cases covering the health endpoint
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/controller/HealthControllerTest.kt
  - Updated: PRD.md (marked US-008 as complete)
- Learnings for future iterations:
  - HealthController tests require @SpringBootTest + @AutoConfigureMockMvc instead of @WebMvcTest
  - This is because the health endpoint uses permitAll() security configuration which needs full Spring context
  - @WebMvcTest with excludeFilters for JwtAuthenticationFilter still enforces Spring Security's default behavior (401 Unauthorized)
  - @SpringBootTest loads the actual SecurityConfig bean, which allows permitAll() endpoints to work correctly
  - The health endpoint is configured as permitAll() in SecurityConfig.kt:40, so no authentication is needed
  - Test cases validate: 200 OK status, JSON response structure, and accessibility without authentication
  - All 3 tests passed successfully after switching to @SpringBootTest approach
  - Typecheck passed successfully
  - Pattern learned: Use @SpringBootTest for endpoints with special security configuration (permitAll, custom filters)
---

## Iteration 60 - Enable TestContainers in repository tests
- Verified that @Disabled annotations were already removed from repository tests (they were already enabled)
- Confirmed TestContainers setup works correctly with all three repository tests
- Files changed:
  - Updated: README.md (added TestContainers documentation in testing section)
  - Updated: PRD.md (marked US-009 as complete)
- Learnings for future iterations:
  - Repository tests (HackathonRepositoryTest, TeamRepositoryTest, UserRepositoryTest) were already enabled - no @Disabled annotations present
  - TestContainers configuration in AbstractRepositoryTest.kt uses postgres:16-alpine image
  - TestContainers automatically starts PostgreSQL in Docker during test execution
  - Tests use @DataJpaTest with @AutoConfigureTestDatabase(replace = NONE) to use TestContainers instead of H2
  - Flyway migrations run automatically in test context (spring.flyway.enabled=true in AbstractRepositoryTest)
  - All repository tests passed successfully (29 tests across 3 test classes)
  - Docker must be running for repository tests to pass - documented this requirement in README
  - TestContainers provides isolated, reproducible test database environment without manual setup
  - Typecheck passed successfully
---

## Iteration 61 - Add PasswordResetTokenRepository tests
- Created comprehensive PasswordResetTokenRepositoryTest.kt with 8 test cases covering all repository methods
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/repository/PasswordResetTokenRepositoryTest.kt
  - Updated: PRD.md (marked US-010 as complete)
- Learnings for future iterations:
  - Repository tests must extend AbstractRepositoryTest and use @DataJpaTest with @AutoConfigureTestDatabase(replace = NONE)
  - Use TestEntityManager to persist test data in setUp() method (e.g., persist testUser before creating tokens)
  - When testing @CreationTimestamp fields, call entityManager.flush() and entityManager.clear() after save to populate database-generated values
  - Test method naming follows pattern: `findByToken should return token when exists`
  - Test complex query methods like findByUserIdAndUsedAtIsNullAndExpiresAtAfter by creating multiple entities with different states (valid, expired, used)
  - Cascade deletion tests verify that deleting a parent entity (User) also deletes child entities (PasswordResetToken)
  - All 8 tests passed successfully when run in isolation (TestContainers connection issues occur when running all tests at once)
  - The repository interface uses findByUserIdAndUsedAtIsNullAndExpiresAtAfter, not findByUserId - important to test the actual method signature
  - Typecheck passed successfully
---

## Iteration 62 - Add ProjectRepository tests
- Created comprehensive ProjectRepositoryTest.kt with 9 test cases covering all repository methods
- Files changed:
  - Created: src/test/kotlin/com/hackathon/manager/repository/ProjectRepositoryTest.kt
  - Updated: PRD.md (marked US-011 as complete)
- Learnings for future iterations:
  - Project entity has relationships with both Team (OneToOne) and Hackathon (ManyToOne)
  - Projects use SubmissionStatus enum with values: draft, submitted, under_review, accepted, rejected (not approved)
  - Test data setup requires persisting User first, then Hackathon, then Team before creating Projects
  - Test cascade deletion from both team and hackathon - both should delete the project
  - Use entityManager.remove() for direct entity deletion or repository.delete() for repository methods
  - Projects have optional fields like tagline, description, urls, and a technologies array field
  - findByHackathonIdAndStatus() is useful for filtering projects by submission status
  - Running all repository tests with --rerun-tasks works better than running individually (avoids TestContainers reuse issues)
  - All 9 tests passed successfully on first run when all repository tests run together
  - Typecheck passed successfully
---
