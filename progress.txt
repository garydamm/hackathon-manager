# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 1 - Add archived_at timestamp to projects table (US-001)
- Created database migration V5__add_archived_at_to_projects.sql
- Added nullable archived_at TIMESTAMP WITH TIME ZONE column to projects table
- Added index idx_projects_archived_at for query performance
- Updated Project.kt entity with archivedAt field
- Added unit test for archivedAt field persistence in ProjectRepositoryTest.kt
- Files changed:
  - src/main/resources/db/migration/V5__add_archived_at_to_projects.sql (new)
  - src/main/kotlin/com/hackathon/manager/entity/Project.kt
  - src/test/kotlin/com/hackathon/manager/repository/ProjectRepositoryTest.kt
  - PRD.md (marked US-001 complete)
- Learnings for future iterations:
  - Migration pattern: Use V{N}__description.sql for sequential migrations
  - Use nullable TIMESTAMP WITH TIME ZONE for archive timestamps (follows existing pattern)
  - Always add index on timestamp columns used in WHERE clauses
  - When testing OffsetDateTime persistence, compare using .toInstant() to handle timezone differences
  - Follow testing strategy: Run controller/service tests, then specific repository test individually to avoid TestContainers resource exhaustion

---

## Iteration 2 - Add archive project server action (US-002)
- Added archiveProject() method to ProjectService.kt
  - Sets archivedAt to OffsetDateTime.now() when archiving
  - Validates project exists (throws NotFoundException)
  - Validates user is team member (throws UnauthorizedException)
  - Validates project not already archived (throws ValidationException)
- Added POST /api/projects/{id}/archive endpoint in ProjectController.kt
  - Uses @AuthenticationPrincipal to extract user ID
  - Returns 200 OK with ProjectResponse on success
- Added comprehensive unit tests in ProjectServiceTest.kt:
  - Test successful archive operation
  - Test exception when project not found
  - Test exception when user not a team member
  - Test exception when project already archived
- Added comprehensive unit tests in ProjectControllerTest.kt:
  - Test successful archive returns 200
  - Test requires authentication (401 without auth)
  - Test permission check (403 when not team member)
  - Test validation (400 when already archived)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/controller/ProjectController.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/controller/ProjectControllerTest.kt
  - PRD.md (marked US-002 complete)
- Learnings for future iterations:
  - Service methods follow pattern: find entity → validate permissions → validate business rules → update → save
  - Controller methods extract userId from @AuthenticationPrincipal principal
  - Test pattern: Mock repository/service responses, verify correct calls
  - Mockito throws UnnecessaryStubbingException if you stub methods that don't get called (remove unnecessary stubs)
  - Validation that happens early in service method (like "already archived" check) runs before later checks (like team member check)
  - Archive operation only checks team member permission (not hackathon organizer), following US-002 requirements
  - All unit tests pass (326 tests), typecheck passes

---
## Iteration 3 - Filter archived projects from all queries (US-003)
- Updated ProjectRepository.kt to filter archived projects in all query methods
  - Changed findByHackathonId → findByHackathonIdAndArchivedAtIsNull
  - Changed findByTeamId → findByTeamIdAndArchivedAtIsNull
  - Changed findByHackathonIdAndStatus → findByHackathonIdAndStatusAndArchivedAtIsNull
  - Changed existsByTeamIdAndHackathonId → existsByTeamIdAndHackathonIdAndArchivedAtIsNull
- Updated ProjectService.kt to use new filtered repository methods
  - getProjectsByHackathon() now excludes archived projects
  - getSubmittedProjectsByHackathon() now excludes archived projects
  - getProjectById() throws NotFoundException if project is archived
  - getProjectByTeam() excludes archived projects
  - createProject() allows team to create new project after archiving previous one
- Updated other services that query projects:
  - ScoringService.kt: getAssignmentsByJudge() excludes archived submitted projects
  - JudgeManagementService.kt: getJudgesByHackathon() and addJudge() exclude archived projects from counts
  - LeaderboardService.kt: getLeaderboard() excludes archived submitted projects
- Added comprehensive unit tests in ProjectServiceTest.kt:
  - Test getProjectsByHackathon excludes archived projects
  - Test getSubmittedProjectsByHackathon excludes archived projects
  - Test getProjectById throws NotFoundException for archived projects
  - Test getProjectByTeam returns null when project is archived
  - Test createProject allows creation when previous project is archived
- Updated all existing test files to use new repository method names:
  - ProjectRepositoryTest.kt (all query tests updated)
  - JudgeManagementServiceTest.kt (3 occurrences)
  - LeaderboardServiceTest.kt (5 occurrences)
  - ScoringServiceTest.kt (2 occurrences)
- Files changed:
  - src/main/kotlin/com/hackathon/manager/repository/ProjectRepository.kt
  - src/main/kotlin/com/hackathon/manager/service/ProjectService.kt
  - src/main/kotlin/com/hackathon/manager/service/ScoringService.kt
  - src/main/kotlin/com/hackathon/manager/service/JudgeManagementService.kt
  - src/main/kotlin/com/hackathon/manager/service/LeaderboardService.kt
  - src/test/kotlin/com/hackathon/manager/service/ProjectServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/repository/ProjectRepositoryTest.kt
  - src/test/kotlin/com/hackathon/manager/service/JudgeManagementServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/service/LeaderboardServiceTest.kt
  - src/test/kotlin/com/hackathon/manager/service/ScoringServiceTest.kt
  - PRD.md (marked US-003 complete)
- Learnings for future iterations:
  - Spring Data JPA method naming: Add "AndArchivedAtIsNull" suffix to filter out archived records
  - When changing repository method signatures, must update ALL references including test files
  - Archived projects are now completely hidden from all queries (hackathon lists, team views, search, direct access)
  - Teams can create new projects after archiving (existsByTeamIdAndHackathonIdAndArchivedAtIsNull excludes archived)
  - getProjectById should throw NotFoundException for archived projects to maintain consistent 404 behavior
  - All affected services (Scoring, JudgeManagement, Leaderboard) must also use filtered queries
  - All unit tests pass (326 tests), typecheck passes
---
